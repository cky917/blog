<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>vue源码学习笔记--Vue数据响应式原理 | 一只很酷的蘑菇</title>
  <meta name="description" content="互联网、前端技术博客，也有二次元和一些生活记录" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="baidu-site-verification" content="2Ph3a2r39z" />
  <meta baidu-gxt-verify-token="2e0d112276ed33a792f971a57f49e4d0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <meta name="generator" content="一只很酷的蘑菇">
  
  
  

  

</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 0" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.png" alt="Blog Logo"/></a> 
            <h1 class="blog-title">一只很酷的蘑菇</h1>
            <h2 class="blog-description"><button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">

  <article class="post">
    <span class="post-meta">
      <time datetime="2018-03-19T10:32:00.000Z" itemprop="datePublished">
        2018-3-19 18:32:00 
      </time>
    
    
    | 
    <a href='/tags/vue源码学习/'>vue源码学习</a>
    
    
</span>
    <h1 class="post-title">vue源码学习笔记--Vue数据响应式原理</h1>
    <span id="busuanzi_container_page_pv" class="readCount">
      阅读量：
    <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>

    </span>
    <section class="post-content">
      <p><a href="https://github.com/cky917/vue-source-code-study" target="_blank" rel="noopener">学习代码仓库</a></p>
<a id="more"></a>
<p>今天来看Vue的数据响应式原理，也就是watch一个值，改变了这个数据，能够得到通知并且在回调里获得新值和旧值从而进行操作，这一个功能的实现。本篇暂不包含与模板层的双向绑定。</p>
<h2 id="数据初始化"><a href="#数据初始化" class="headerlink" title="数据初始化"></a>数据初始化</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo/index.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue3</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 每次执行new Vue()操作都会执行的构造函数</span></span><br><span class="line">Vue3.prototype._init = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="keyword">this</span></span><br><span class="line">  vm.$options = options || &#123;&#125;</span><br><span class="line">  vm._watchers = []</span><br><span class="line">  <span class="keyword">if</span> (vm.$options.data) initData(vm)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.$options.data</span><br><span class="line">  <span class="comment">// 将配置项data的值挂载在vm._data上，如果data是个函数，则调用`getData`方法获取返回值</span></span><br><span class="line">  data = vm._data = <span class="keyword">typeof</span> data === <span class="string">'function'</span> ? getData(data, vm) : data || &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...省略data的校验步骤</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(data)</span><br><span class="line">  <span class="keyword">let</span> i = keys.length</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="comment">// ...省略data的key值校验步骤</span></span><br><span class="line">    <span class="comment">// 遍历 data 的 key，把 data 上的属性代理到 vm 实例上</span></span><br><span class="line">    proxy(vm, <span class="string">'_data'</span>, key)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// observe(data, true /* asRootData */)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params">data, vm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data.call(vm, vm)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(e)</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">noop</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">target, sourceKey, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> sharedPropertyDefinition = &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    get: noop,</span><br><span class="line">    set: noop</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取 vm[key]值的时候，返回vm._data[key]</span></span><br><span class="line">  sharedPropertyDefinition.get = <span class="function"><span class="keyword">function</span> <span class="title">proxyGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[sourceKey][key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 设置 vm[key]值的时候，vm._data[key] = val</span></span><br><span class="line">  sharedPropertyDefinition.set = <span class="function"><span class="keyword">function</span> <span class="title">proxySetter</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>[sourceKey][key] = val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将[key]挂载在vm上</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.Vue3 = Vue3</span><br></pre></td></tr></table></figure>
<p>通过以上的初始化，成功让配置项里<code>data</code>的每个值都挂到了<code>vm</code>实例上。并且<code>vm[key]</code>的操作会同步到<code>vm._data[key]</code>上</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> Vue3(&#123;</span><br><span class="line">  data()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="string">'cky'</span>,</span><br><span class="line">      age: <span class="number">18</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/images/5.png"><br><img src="/images/6.png"></p>
<h2 id="Observer、Watcher、Dep"><a href="#Observer、Watcher、Dep" class="headerlink" title="Observer、Watcher、Dep"></a>Observer、Watcher、Dep</h2><p>接下来要说的三个类<code>Observer</code>、<code>Watcher</code>、<code>Dep</code>，我们先提前搞清楚他们三个的作用。<br><code>Observer</code>类是用来把一个值变得可观测的工具，它会循环传入的值，然后改写它们的<code>getter/setter</code>。它的实例方法有<code>observeArray</code>和<code>walk</code>，分别把数组和对象类型变得可观测。</p>
<p><code>Watcher</code>可以设定多个观察对象，然后对于它们的改变做出相应行为。它的实例方法有以下：</p>
<ul>
<li><code>get()</code>。根据传入的表达式或函数，计算出值</li>
<li><code>addDep(dep)</code>。如果没有将自身传入过该<code>dep</code>记录依赖,则将自身传入，调用<code>dep.addSub(this)</code></li>
<li><code>cleanupDeps()</code>。清理不再依赖的<code>dep</code>, 同时在<code>dep</code>的依赖列表中移除自身</li>
<li><code>update()</code>。订阅者接口，当订阅的值改变时会触发</li>
<li><code>run()</code>。对比前后值，如果前后值发生了改变，或者<code>deep</code>为<code>true</code>，或者该值为对象，则触发cb回调。</li>
<li><code>evaluate()</code>。触发<code>this.get()</code> 只会在<code>lazy watcher</code>里被触发</li>
<li><code>depend()</code>。循环触发<code>this.deps</code>的项的<code>depend()</code>方法</li>
<li><code>teardown()</code>。销毁<code>watcher</code>，从所有的<code>this.deps</code>里移除自身，并且将<code>active</code>设为<code>false</code></li>
</ul>
<p><code>Dep</code>类是针对某个值的依赖收集器，比如id为1的<code>Dep</code>实例对象是负责收集<code>_data.name</code>的依赖的，那以后所有对这个值的进行观测的<code>watcher</code>都会被统计到这个实例里。<br>它的实例方法有如下：</p>
<ul>
<li><code>addSub(sub: Watcher)</code>。 增加依赖</li>
<li><code>removeSub (sub: Watcher)</code>。 移除依赖</li>
<li><code>depend()</code>。如果有<code>Watcher</code>在<code>Dep.target</code>, 则将这个<code>Watcher</code>加入依赖</li>
<li><code>notify()</code>。调用所有的<code>subs</code>的<code>update()</code>方法。</li>
</ul>
<p>上面在<code>initData()</code>函数中注释了一句</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">observe(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br></pre></td></tr></table></figure>
<p>现在来看看这个函数是干什么的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /demo/observer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; isObject &#125; <span class="keyword">from</span> <span class="string">'./util'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">value, asRootData</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果不是对象，直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (!isObject(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> ob</span><br><span class="line">  <span class="comment">// 如果value对象上有__ob__属性，而且这个属性是Observer类的一个实例</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(value, <span class="string">'__ob__'</span>) &amp;&amp; value.__ob__ <span class="keyword">instanceof</span> Observer) &#123;</span><br><span class="line">    ob = value.__ob__</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 否则ob为一个新的Oserver实例</span></span><br><span class="line">    ob = <span class="keyword">new</span> Observer(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果是vm.$data, 那么 ob.vmCount++</span></span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.vmCount++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hasOwnProperty = <span class="built_in">Object</span>.prototype.hasOwnProperty</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">hasOwn</span>(<span class="params">obj, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> hasOwnProperty.call(obj, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">def</span>(<span class="params">obj, key, val, enumerable</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    value: val,</span><br><span class="line">    enumerable: !!enumerable,</span><br><span class="line">    writable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下上面干了什么，<code>observe</code>函数返回的是一个<code>Observer</code>类的实例，如果传入的value有<code>__ob__</code>属性，直接返回，如果没有 则传入<code>value</code>值去构造一个<code>Observer</code>的实例并返回。</p>
<p>我们再来看看<code>Observer</code>类的定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  <span class="comment">// value</span></span><br><span class="line">  <span class="comment">// dep</span></span><br><span class="line">  <span class="comment">// vmCount // number of vms that has this object as root $data</span></span><br><span class="line">  <span class="keyword">constructor</span>(value) &#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value</span><br><span class="line">    <span class="keyword">this</span>.vmCount = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 给value添加'__ob__'属性，就是这个实例</span></span><br><span class="line">    def(value, <span class="string">'__ob__'</span>, <span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">this</span>.walk(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 循环每个属性，并转换它们的getter/setters，这个方法只能用于Object类型的值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  walk(obj) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">      <span class="comment">// 第一次初始化时， obj: vm._data  keys[i]: key, obj[keys[i]]: value</span></span><br><span class="line">      defineReactive(obj, keys[i], obj[keys[i]])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在一个对象上定义一个响应式的属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val, customSetter, shallow</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key)</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.get</span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.set</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 如果之前这个字段已经定义过getter了就用之前的getter</span></span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">        <span class="comment">// 如果值没有改变 或者类似 NaN !== NaN这种情况</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">        customSetter()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        setter.call(obj, newVal)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`我被改变了，新值:<span class="subst">$&#123;newVal&#125;</span>, 旧值:<span class="subst">$&#123;value&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下上面的操作，<code>Observer</code>的构造函数给传入的<code>value</code>值增加<code>__ob__</code>属性，也就是这个构造出的实例，并且如果<code>value</code>是对象类型，会循环它的每个属性，调用<code>defineReactive</code>方法，而这个方法就是改写每个属性的<code>getter/setter</code>，从而可以在进行值获取和赋值的时候进行某些操作，也就能监听到值的改变。</p>
<p>看看执行上面代码的结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> Vue3(&#123;</span><br><span class="line">  data()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="string">'cky'</span>,</span><br><span class="line">      age: <span class="number">18</span>,</span><br><span class="line">      mom: &#123;</span><br><span class="line">      name: <span class="string">'zj'</span>,</span><br><span class="line">        age: <span class="number">28</span></span><br><span class="line">      &#125;,</span><br><span class="line">      friends: [<span class="string">'aa'</span>, <span class="string">'bbb'</span>, <span class="string">'ccc'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/images/7.png"><br><img src="/images/9.png"><br><img src="/images/8.png"></p>
<p>之前对于<code>vm.age</code>和<code>vm.name</code>也有<code>getter</code>和<code>setter</code>的重写，和这里的<code>vm._data.age</code>的<code>getter/setter</code>是不一样的，在<code>vm.age</code>的<code>getter</code>是去读<code>vm._data.age</code>，从而触发<code>vm._data.age</code>的<code>getter</code>，<code>setter</code>同理。其实真正对于数据改变的监听是在<code>_data</code>属性上的<code>getter</code>和<code>setter</code>上完成的。</p>
<h3 id="数组更新检测"><a href="#数组更新检测" class="headerlink" title="数组更新检测"></a>数组更新检测</h3><p>上面的操作在数组执行<code>push</code>这类的会改变数组的方法的时候，却没有任何作用，因为这个并不会触发<code>setter</code>。那对于数组<code>Vue</code>又是怎么处理的呢。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /demo/observer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; arrayMethods &#125; <span class="keyword">from</span> <span class="string">'./array'</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(value) &#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value</span><br><span class="line">    <span class="keyword">this</span>.dep = <span class="keyword">new</span> Dep()</span><br><span class="line">    <span class="keyword">this</span>.vmCount = <span class="number">0</span></span><br><span class="line">    def(value, <span class="string">'__ob__'</span>, <span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">      value.__proto__ = arrayMethods</span><br><span class="line">      <span class="keyword">this</span>.observeArray(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.walk(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// walk()...</span></span><br><span class="line">  observeArray (items) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.length; i &lt; l; i++) &#123;</span><br><span class="line">      observe(items[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /demo/array.js</span></span><br><span class="line"><span class="keyword">const</span> arrayProto = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="built_in">Object</span>.create(arrayProto)</span><br><span class="line"><span class="keyword">const</span> methodsToPatch = [</span><br><span class="line">  <span class="string">'push'</span>,</span><br><span class="line">  <span class="string">'pop'</span>,</span><br><span class="line">  <span class="string">'shift'</span>,</span><br><span class="line">  <span class="string">'unshift'</span>,</span><br><span class="line">  <span class="string">'splice'</span>,</span><br><span class="line">  <span class="string">'sort'</span>,</span><br><span class="line">  <span class="string">'reverse'</span></span><br><span class="line">]</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Intercept mutating methods and emit events</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">methodsToPatch.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// cache original method</span></span><br><span class="line">  <span class="keyword">const</span> original = arrayProto[method]</span><br><span class="line">  def(arrayMethods, method, <span class="function"><span class="keyword">function</span> <span class="title">mutator</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = original.apply(<span class="keyword">this</span>, args)</span><br><span class="line">    <span class="keyword">const</span> ob = <span class="keyword">this</span>.__ob__</span><br><span class="line">    <span class="keyword">let</span> inserted</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'push'</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'unshift'</span>:</span><br><span class="line">        inserted = args</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">        inserted = args.slice(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inserted) ob.observeArray(inserted)</span><br><span class="line">    <span class="comment">// notify change</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`我是数组，被<span class="subst">$&#123;method&#125;</span>方法改变了`</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这个<code>array.js</code>文件<code>export</code>出了一个 <code>arrayMethods</code>，<code>arrayMethods</code> 继承了 <code>Array.prototype</code>，并在自身定义了那些变异方法来拦截原始数组的那些方法调用。<br>我们知道，当我们访问对象上的一个属性的时候，假如对象自身不存在这个属性，则会延续到它的 <code>__proto__</code> 上去找，找不到就继续。所以上面只需要把数组的 <code>__proto__</code> 指向 vue 自己的 <code>ArrayMethods</code> 就实现了拦截部分属性并继承原始 <code>Array</code> 的其他原型方法，十分巧妙。</p>
<p><img src="/images/10.png"></p>
<p>官方文档说，不支持直接对数组<code>this.xx[n] = xyz</code>这样的赋值监听，提供了<code>Vue.set</code>和<code>this.$set</code> 方法，其实这个方法内部在前一篇也讲了，就是调用了<code>splice</code>这个变异方法从而实现监听。</p>
<h3 id="依赖收集"><a href="#依赖收集" class="headerlink" title="依赖收集"></a>依赖收集</h3><p><br>上面的操作还是仅仅是观察者能够监听到了数组的变化，观察者看到发生变化后，就要去通知那些订阅者(<code>watcher</code>)。那这个订阅依赖是怎么统计起来的呢。首先，我们需要定义一个<code>Dep</code>类，这是观察者和订阅者的桥梁，它统计了所有的watcher，然后统一发出通知。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /demo/dep.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">this</span>.id = uid++</span><br><span class="line">    <span class="keyword">this</span>.subs = []</span><br><span class="line">  &#125;</span><br><span class="line">  addSub () &#123;...&#125;  <span class="comment">// 添加订阅者(依赖)</span></span><br><span class="line">  removeSub () &#123;...&#125;  <span class="comment">// 删除订阅者(依赖)</span></span><br><span class="line">  depend () &#123;...&#125;  <span class="comment">// 检查当前Dep.target是否存在以及判断这个watcher已经被添加到了相应的依赖当中，如果没有则添加订阅者(依赖)，如果已经被添加了那么就不做处理</span></span><br><span class="line">  notify () &#123;...&#125;  <span class="comment">// 通知订阅者(依赖)更新</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而什么时候该去添加依赖呢，其实就是你在获取这个值，而且说明自己是个订阅者的时候，就可以把你作为这个值的依赖了。<br>这一步就在<code>defineReactive</code>方法里实现，这一步重写了<code>getter</code>和<code>setter</code>，所以只需要在<code>getter</code>里记录依赖，在<code>setter</code>里通知改变就行了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /demo/observer.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val, customSetter, shallow</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep() <span class="comment">// 该值的依赖收集器</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; observe(val) <span class="comment">// 返回的是一个Observer实例</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123; <span class="comment">// 当订阅者存在的时候，才进行依赖收集</span></span><br><span class="line">        dep.depend() <span class="comment">// 依赖收集，</span></span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.dep.depend()</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">            dependArray(value)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      dep.notify()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Vue</code>的订阅者实现是一个<code>Watcher</code>类，在<code>Vue</code>的生命周期里，有四个地方会实例化这个类。</p>
<ul>
<li><code>Vue</code>实例化的过程中有<code>watch</code>选项</li>
<li><code>Vue</code>实例化的过程中有<code>computed</code>计算属性选项</li>
<li><code>Vue</code>原型上有挂载<code>$watch</code>方法: <code>Vue.prototype.$watch</code>，可以直接通过实例调用<code>this.$watch</code>方法</li>
<li><code>Vue</code>生成了<code>render</code>函数，更新视图时</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo/watcher.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (vm, expOrFn, cb, options) &#123;</span><br><span class="line">    <span class="comment">// 缓存这个实例vm</span></span><br><span class="line">    <span class="keyword">this</span>.vm = vm</span><br><span class="line">    <span class="comment">// vm实例中的_watchers中添加这个watcher</span></span><br><span class="line">    vm._watchers.push(<span class="keyword">this</span>)</span><br><span class="line">    <span class="comment">// options</span></span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">      <span class="keyword">this</span>.deep = !!options.deep</span><br><span class="line">      <span class="keyword">this</span>.user = !!options.user</span><br><span class="line">      <span class="keyword">this</span>.lazy = !!options.lazy</span><br><span class="line">      <span class="keyword">this</span>.sync = !!options.sync</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.deep = <span class="keyword">this</span>.user = <span class="keyword">this</span>.lazy = <span class="keyword">this</span>.sync = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.cb = cb</span><br><span class="line">    <span class="keyword">this</span>.id = ++uid <span class="comment">// uid for batching</span></span><br><span class="line">    <span class="keyword">this</span>.active = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">this</span>.dirty = <span class="keyword">this</span>.lazy <span class="comment">// for lazy watchers</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">// parse expression for getter</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.getter = expOrFn</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// eg: 'a.b.c'，parsePath方法返回了一个函数，接收obj参数，然后返回obj[a][b][c]的值</span></span><br><span class="line">      <span class="keyword">this</span>.getter = parsePath(expOrFn)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.getter) &#123;</span><br><span class="line">        <span class="keyword">this</span>.getter = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过get方法去获取最新的值</span></span><br><span class="line">    <span class="comment">// 如果lazy为true, 初始化的时候为undefined</span></span><br><span class="line">    <span class="keyword">this</span>.value = <span class="keyword">this</span>.lazy</span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : <span class="keyword">this</span>.get()</span><br><span class="line">  &#125;</span><br><span class="line">  get () &#123;...&#125;</span><br><span class="line">  addDep () &#123;...&#125;</span><br><span class="line">  update () &#123;...&#125;</span><br><span class="line">  run () &#123;...&#125;</span><br><span class="line">  evaluate () &#123;...&#125;</span><br><span class="line">  run () &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在除了<code>computed</code>选项外，其他几种实例化<code>watcher</code>的方式都是在实例化过程中完成求值及依赖的收集工作：<code>this.value = this.lazy ? undefined : this.get()</code>.在<code>Watcher</code>的<code>get</code>方法中:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">get () &#123;</span><br><span class="line">  <span class="comment">// pushTarget即设置当前的需要被执行的watcher</span></span><br><span class="line">  pushTarget(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">let</span> value</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="keyword">this</span>.vm</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// $watch(function () &#123;&#125;)</span></span><br><span class="line">    <span class="comment">// 调用this.getter的时候，触发了属性的getter函数</span></span><br><span class="line">    <span class="comment">// 在getter中进行了依赖的管理</span></span><br><span class="line">    value = <span class="keyword">this</span>.getter.call(vm, vm)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    handleError(e, vm, <span class="string">`getter for watcher "<span class="subst">$&#123;<span class="keyword">this</span>.expression&#125;</span>"`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// traverse方法其实就是遍历读取了value的值，从而遍历触发了下面的`getter`从而进行了依赖收集</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.deep) &#123;</span><br><span class="line">    traverse(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 完成了依赖收集</span></span><br><span class="line">  popTarget()</span><br><span class="line">  <span class="comment">// 清理和删除老旧依赖</span></span><br><span class="line">  <span class="keyword">this</span>.cleanupDeps()</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>get()</code>方法中触发了<code>getter</code>，调用<code>dep.depend()</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo/dep.js</span></span><br><span class="line">  depend () &#123;</span><br><span class="line">    <span class="comment">// 检查当前Dep.target是否存在以及判断这个watcher已经被添加到了相应的依赖当中，如果没有则添加订阅者(依赖)，如果已经被添加了那么就不做处理</span></span><br><span class="line">    <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">      <span class="comment">// Dep.target为一个watcher</span></span><br><span class="line">      Dep.target.addDep(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo/watcher.js</span></span><br><span class="line">  <span class="comment">// 添加依赖</span></span><br><span class="line">  addDep(dep) &#123;</span><br><span class="line">    <span class="comment">// 某值的依赖收集器实例，如果这个依赖没有被收集过</span></span><br><span class="line">    <span class="keyword">const</span> id = dep.id</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.newDepIds.has(id)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.newDepIds.add(id)</span><br><span class="line">      <span class="keyword">this</span>.newDeps.push(dep)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.depIds.has(id)) &#123;</span><br><span class="line">        dep.addSub(<span class="keyword">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>其他细节代码就不细说了，现在完善了代码，执行以下代码后：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> Vue3(&#123;</span><br><span class="line">  data()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">       name: <span class="string">'cky'</span>,</span><br><span class="line">       age: <span class="number">18</span>,</span><br><span class="line">       mom: &#123;</span><br><span class="line">	     name: <span class="string">'zj'</span>,</span><br><span class="line">         age: <span class="number">28</span></span><br><span class="line">       &#125;,</span><br><span class="line">       friends: [<span class="string">'aa'</span>, <span class="string">'bbb'</span>, <span class="string">'ccc'</span>],</span><br><span class="line">       classmate: [<span class="string">'dd'</span>, <span class="string">'ee'</span>, <span class="string">'gg'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">a.$watch(<span class="string">'name'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(newValue, oldValue)</span><br><span class="line">&#125;)</span><br><span class="line">a.$watch(<span class="string">'age'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(newValue, oldValue)</span><br><span class="line">&#125;)</span><br><span class="line">a.$watch(<span class="string">'age'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(newValue, oldValue)</span><br><span class="line">&#125;)</span><br><span class="line">a.$watch(<span class="string">'name'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(newValue, oldValue)</span><br><span class="line">&#125;)</span><br><span class="line">a.$watch(<span class="string">'age'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(newValue, oldValue)</span><br><span class="line">&#125;)</span><br><span class="line">a.$watch(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="keyword">this</span>.age</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(newValue, oldValue)</span><br><span class="line">&#125;)</span><br><span class="line">a.$watch(<span class="string">'age'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">newValue, oldValue</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(newValue, oldValue)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="/images/11.png"><br><img src="/images/12.png"><br><img src="/images/13.png"><br><img src="/images/14.png"></p>
<p>其中<code>Dep.id</code>为1的是对<code>name</code>值的依赖收集器，它下面有id为1、4、6的<code>watcher</code>。<br><code>Dep.id</code>为2的是对<code>age</code>的依赖收集器，它的收集的订阅者有<code>id</code>为2、3、5、6、7的<code>watcher</code><br><code>id</code>为6的<code>watcher</code>因为用到了<code>name</code>和<code>age</code>2个值，所以上面都有他，而它的<code>deps</code>字段也能看出来</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://segmentfault.com/a/1190000010014281" target="_blank" rel="noopener">Vue的数据依赖实现原理简析</a></p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>陈柯伊</h4>
    <p>梦想一克拉 热血一卡车 眼泪一酒瓶 熬夜一光年</p>
</section>
      <section class="share">
   <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    
    <a class="older-posts" href="/2018/03/09/vue-source-code-study-2/">
        vue源码学习笔记--全局api解析 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">评论</a></h4>
    
    
<section class="comment-box">
    <!--高速版-->
    <div id="SOHUCS" sid="https://coolmogu.com/2018/03/19/vue-source-code-study-3/"></div>
    <script charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/changyan.js" ></script>
    <script type="text/javascript">
        window.changyan.api.config({
        appid: 'cyt0WGpod',
        conf: 'prod_9f27eeee1e3fc8f350351d688de22e09'
        });
    </script>

</section>

</div>



</main>
 
  <div id="toc" class="toc-article">
    <div class="toc-title">文章目录</div>
    <div class="toc-box">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据初始化"><span class="toc-text">数据初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Observer、Watcher、Dep"><span class="toc-text">Observer、Watcher、Dep</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数组更新检测"><span class="toc-text">数组更新检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖收集"><span class="toc-text">依赖收集</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
    </div>

</div>


<script language="JavaScript" type="text/JavaScript">
//运行文本域代码
function runEx(cod1) {
  cod=document.all(cod1)
  var code=cod.value.replace(/‘|’/g,'\'');
  if (code!=""){
    var newwin=window.open('','',''); //打开一个窗口并赋给变量newwin。
    newwin.opener = null // 防止代码对论谈页面修改
    newwin.document.write(code); //向这个打开的窗口中写入代码code，这样就实现了运行代码功能。
    newwin.document.close();
  }
}

</script>

      
<footer class="site-footer">
  
  <div class="inner">
<section>友情链接：
  <a href="https://wangfeia.com/" target="_blank" rel="nofollow">WangF Blog</a> |
  <a href="http://neras.github.io/" target="_blank" rel="nofollow">有只妖怪</a> |
  <a href="http://www.cnblogs.com/observernotes/" target="_blank" rel="nofollow">observernote</a> |
  <a href="http://tangyc.top/" target="_blank" rel="nofollow">前端唐小胖</a>|
  <a href="http://lyhfe.com/" target="_blank" rel="nofollow">lyhper Blog</a>
<a href="https://haofly.net/" target="_blank" rel="nofollow">豪翔天下</a>
</section>
     <section class="copyright">All content copyright <a href="/">一只很酷的蘑菇</a> &copy; 2015 &bull; All rights reserved. </section>
     <section class="poweredby">渝ICP备15005710号 |  Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a> </section>
  </div>
  <span id="busuanzi_container_site_uv">
      本站访客数<span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span>人次
    </span>
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
</footer>

      <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="/js/underscore-min.js"></script>
<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>




  </div>
</div>
<nav  class="outer-nav top horizontal">

          <a class="icon-home" target="_blank" href="/"><span>博客主页</span></a>

          <a class="icon-news" target="_blank" href="/tags/Javascript学习笔记/"><span>博客目录</span></a>

          <a class="icon-image" target="_blank" href="/my-project/"><span>我的项目</span></a>

          <a class="icon-wiki" target="_blank" href="http://github.com/cky917"><span>github</span></a>

          <a class="icon-mail" target="_blank" href="/about-me/"><span>关于我</span></a>

</nav>

</div>
</body>
</html>
