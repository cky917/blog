title: 浏览器的重绘与重排
date: 2015-9-23 20:46:25
tag: web前端知识
---

前端开发的过程中，我们不仅要实现设计师提供的炫酷设计稿，同时还要考虑到用最好的方式，最优的性能去实现它。为此，我们需要了解浏览器的重绘与重排概念。
<!--more-->
首先我们要先了解浏览器从下载文档到显示页面的过程，这里面就包含了重绘与重排。
>简单讲，通常在文档初次加载时，浏览器引擎会解析HTML文档来构建DOM树，之后根据DOM元素的几何属性构建一棵用于渲染的树。渲染树的每个节点都有大小和边距等属性，类似于盒子模型（由于隐藏元素不需要显示，渲染树中并不包含DOM树中隐藏的元素）。当渲染树构建完成后，浏览器就可以将元素放置到正确的位置了，再根据渲染树节点的样式属性绘制出页面。由于浏览器的流布局，对渲染树的计算通常只需要遍历一次就可以完成。但table及其内部元素除外，它可能需要多次计算才能确定好其在渲染树中节点的属性，通常要花3倍于同等元素的时间。这也是为什么我们要避免使用table做布局的一个原因。

重绘的概念：
>重绘是一个元素外观的改变所触发的浏览器行为，例如改变visibility、outline、背景色等属性。浏览器会根据元素的新属性重新绘制，使元素呈现新的外观。重绘不会带来重新布局，并不一定伴随重排。

重排（也称作回流）是更明显的一种改变，可以理解为渲染树需要重新计算。

触发重排的常见情况有三种：
1. DOM元素的几何属性变化
一个DOM元素的几何属性实现改变，会使浏览器重新构建此节点，而且也许会带来相关元素的重排。浏览器会计算相关元素如兄弟元素、子元素的尺寸，进行重新绘制。可见，重排一定会引起浏览器的重绘，一个元素的重排通常带来一系列的反应，性能代价是高昂的。

2. DOM树的结构变化
    当DOM树的结构变化时，例如节点的增减、移动等，也会触发重排。浏览器的布局过程类似于树的前序遍历，是一个从从上到下从左到右的过程。所以，如果在Body最前面插入一个元素，会导致整个文档树的重排，而在最后插入元素，不会影响前面的元素。
3. 获取某些属性
    当获取某些属性时，浏览器为了取得正确的值，也会触发重排。这些属性包括：offsetTop、offsetLeft、 offsetWidth、offsetHeight、scrollTop、scrollLeft、scrollWidth、scrollHeight、clientTop、clientLeft、clientWidth、clientHeight、getComputedStyle()

    所以，在多次使用这些值时，应该进行缓存。

开发中减少重排次数和缩小重排范围的方法：
1. 将多次改变样式属性的操作合并为一次操作，也就是将需要改变的的样式写在css中，并给一个类名，在js中只需要改变className即可。

2. 需要多次重排的元素，position值最好为absolute或者fix，让它脱离文档流，这样就不会影响其他元素。所以有动画效果的元素最好设置绝对定位。

3. 需要增加多个节点，可以一次性构建一个html片段，然后一次性添加到文档中去，而不是循环添加每一行。

4. 由于display为none的元素不再渲染树中，对隐藏元素的操作不会引发其他元素的重排。如果要对一个元素进行复杂操作，可以先隐藏它，操作完成后再显示。这样只在隐藏和显示时触发2次重排。

5. 在需要经常获取那些引起浏览器重排的属性值时，要缓存到变量。